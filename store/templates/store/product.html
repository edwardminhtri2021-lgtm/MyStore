{% extends "store/base.html" %}
{% load static %}
{% load humanize %}
{% block body_block %}

<!-- Wishlist + User + Cart -->
<div class="attr-nav">
    <ul class="d-flex align-items-center">
        <!-- Wishlist (nút tim nhỏ ở header) -->
        <li class="wishlist mr-3">
            <a href="{% url 'store:wishlist' %}" class="single-icon" id="wishlist-link">
                <i class="fa fa-heart"></i>
                <span class="badge badge-danger" id="wishlist-count">
                    {% if request.session.wishlist %}
                        {{ request.session.wishlist|length }}
                    {% else %}
                        0
                    {% endif %}
                </span>
            </a>
        </li>

        <!-- User -->
        <li class="account mr-3">
            {% if user.is_authenticated %}
                <a href="#"><i class="fa fa-user-circle-o"></i> {{ user.username }}</a>
            {% else %}
                <a href="{% url 'store:login' %}"><i class="fa fa-user-circle-o"></i> Đăng nhập</a>
            {% endif %}
        </li>

        <!-- Cart -->
        <li class="cart">
            <a href="{% url 'store:cart' %}" class="single-icon">
                <i class="ti-bag"></i>
                {% if cart %}
                    <span class="badge badge-danger">{{ cart|length }}</span>
                {% endif %}
            </a>
        </li>
    </ul>
</div>

<!-- Product Detail Section -->
<div class="container mt-4">
    <div class="row">
        <!-- Product Image -->
        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid">

            {% if list_asc_products|length > 0 %}
            <div class="mt-4">
                <h4>Sản phẩm hay được mua cùng</h4>
                <ul class="list-unstyled">
                    {% for p in list_asc_products %}
                        <li>
                            <a href="{% url 'store:product.html' p.pk %}">{{ p.name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

        <!-- Product Info -->
        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12">
            <div class="quickview-content">
                <h2>{{ product.name }}</h2>
                <div class="quickview-ratting-review d-flex justify-content-between">
                    <div class="quickview-ratting-wrap">
                        {{ product.viewed }} views
                    </div>
                    <div class="quickview-stock">
                        <span><i class="fa fa-check-circle-o"></i> Đang mở bán</span>
                    </div>
                </div>
                <h4>{{ product.price|floatformat:0|intcomma }} đ</h4>

                <h3>Thông tin sản phẩm</h3>
                <div class="quickview-peragraph">
                    <p>{{ product.content|safe }}</p>
                </div>

                <!-- Quantity -->
                <div class="quantity mb-3">
                    <div class="input-group">
                        <div class="button minus">
                            <button type="button" class="btn btn-primary btn-number" disabled data-type="minus" data-field="quant[1]">
                                <i class="ti-minus"></i>
                            </button>
                        </div>
                        <input type="text" name="quant[1]" class="input-number" data-min="1" data-max="1000" value="1">
                        <div class="button plus">
                            <button type="button" class="btn btn-primary btn-number" data-type="plus" data-field="quant[1]">
                                <i class="ti-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add to Cart -->
                <div class="add-to-cart mb-2">
                    <form method="POST" action="{% url 'store:add_to_cart' product.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="qty" value="1">
                        <button type="submit" class="btn btn-primary">Chọn mua</button>
                    </form>
                </div>

                <!-- Nút lớn Thêm vào Wishlist -->
                <button class="btn btn-lg btn-outline-danger mt-2" id="add-to-wishlist-btn" data-product-id="{{ product.id }}">
                    <i class="fa fa-heart"></i> Thêm vào Wishlist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script xử lý wishlist -->
<script>
const wishlistBtn = document.getElementById('add-to-wishlist-btn');
wishlistBtn.addEventListener('click', function(){
    const productId = this.dataset.productId;
    fetch("{% url 'store:add_to_wishlist' 0 %}".replace('0', productId), {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if(data.success){
            document.getElementById('wishlist-count').textContent = data.count;
            // Chuyển luôn sang trang wishlist nếu muốn
            window.location.href = "{% url 'store:wishlist' %}";
        }
    });
});
</script>

{% endblock %}
